<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home Utente</title>
    <link rel="stylesheet" href="/css/navbar-sidebar.css" />
    <link rel="stylesheet" href="/css/home-utente.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"
    />
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <!-- ✅ Libreria MQTT per browser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <!-- Poi: Singleton MQTT Manager -->
    <script src="/js/mqtt-manager.js"></script>
  </head>

  <body>
    <!-- ===== APP CONTAINER ===== -->
    <div id="app">
      <!-- ===== NAVBAR (IMPORTATO) ===== -->
      <%- include('./components/navbar') %>

      <!-- ===== SIDEBAR (IMPORTATO) ===== -->
      <%- include('./components/sidebar') %>

      <!-- ===== MAIN CONTENT ===== -->
      <main class="main-content">
        <div class="container">
          <!-- ===== HOMEPAGE ===== -->
          <section id="homepage" class="page-section active">
            <!-- ✅ NUOVO: TOP BANNER (Corsa attiva o Credito basso) -->
            <div id="topBannerContainer"></div>

            <!-- ===== 1️⃣ MAPPA PARCHEGGI CON LEAFLET ===== -->
            <div class="card mb-6">
              <div class="card-header">
                <h2 class="card-title">
                  <i class="fas fa-map"></i>
                  Mappa Parcheggi
                </h2>
              </div>
              <div class="card-body" style="padding: 0">
                <div id="parkingMap"></div>
              </div>
            </div>

            <!-- ===== 1️⃣ MAPPA PARCHEGGI ===== -->
            <div class="card mb-6">
              <div class="card-header">
                <h2 class="card-title">
                  <i class="fas fa-map-marker-alt"></i>
                  Parcheggi
                </h2>
              </div>
              <div class="card-body">
                <div class="parking-grid" id="parkingGrid">
                  <!-- Generato dinamicamente -->
                </div>
              </div>
            </div>

            <!-- ===== 2️⃣ CARD VEICOLI CON FILTRI ===== -->
            <div class="card mb-6">
              <div class="card-header">
                <h2 class="card-title">
                  <i class="fas fa-motorcycle"></i>
                  Veicoli
                </h2>

                <!-- ===== FILTRI INTERNI DELLA CARD ===== -->
                <div class="vehicles-filter-container mb-6">
                  <button class="filter-btn active" data-filter="all">
                    <i class="fas fa-th"></i>
                    Tutti
                  </button>
                  <button class="filter-btn" data-filter="bicicletta_muscolare">
                    <i class="fas fa-bicycle"></i>
                    Biciclette Muscolari
                  </button>
                  <button class="filter-btn" data-filter="monopattini">
                    <i class="fas fa-person-skating"></i>
                    Monopattini Elettrici
                  </button>
                  <button class="filter-btn" data-filter="bicicletta_elettrica">
                    <i class="fas fa-bolt"></i>
                    Biciclette Elettriche
                  </button>
                </div>

                <!-- ===== SELECT FILTER (HIDDEN DI DEFAULT) ===== -->
                <select id="filterSelect" class="filter-select hidden">
                  <option value="all">Tutti</option>
                  <option value="bicicletta_muscolare">
                    Biciclette Muscolari
                  </option>
                  <option value="monopattini">Monopattini Elettrici</option>
                  <option value="bicicletta_elettrica">
                    Biciclette Elettriche
                  </option>
                </select>
              </div>
              <div class="card-body">
                <!-- ===== LOADING SPINNER ===== -->
                <div id="loadingSpinner" class="loading-spinner hidden">
                  <div class="spinner"></div>
                  <p>Caricamento mezzi...</p>
                </div>

                <!-- ===== VEHICLES GRID ===== -->
                <div class="vehicles-grid" id="vehiclesGrid">
                  <!-- Generato dinamicamente -->
                </div>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <!-- ===== SNACKBAR NOTIFICHE ===== -->
    <div id="snackbar" class="snackbar"></div>

    <!-- ===== MODAL ELIMINA PROFILO ===== -->
    <div id="deleteProfileModal" class="modal hidden">
      <div class="modal-overlay"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Elimina Profilo</h2>
          <button class="modal-close" id="modalClose">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <p>Sei sicuro di voler eliminare il tuo profilo?</p>
          <p class="modal-warning">
            <strong>Questa azione non può essere annullata.</strong>
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" id="modalConfirmDelete">
            Elimina Profilo
          </button>
          <button class="btn btn-secondary" id="modalCancel">Annulla</button>
        </div>
      </div>
    </div>

    <!-- ===== MODAL PRENOTAZIONE ===== -->
    <div id="reservationModal" class="modal hidden">
      <div class="modal-overlay"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Conferma Prenotazione</h2>
          <button class="modal-close" id="modalClose">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="vehicle-summary">
            <div class="summary-item">
              <span class="summary-label">Mezzo:</span>
              <span class="summary-value" id="summaryVehicleId">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Tipologia:</span>
              <span class="summary-value" id="summaryVehicleType">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Batteria:</span>
              <span class="summary-value" id="summaryBattery">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Parcheggio:</span>
              <span class="summary-value" id="summaryParking">-</span>
            </div>
          </div>
          <div class="warning-box">
            <i class="fas fa-info-circle"></i>
            <p>
              Assicurati di avere saldo sufficiente. La tariffa è di €1,00 per i
              primi 30 minuti.
            </p>
          </div>

          <div id="reservationError" class="error-box hidden"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="confirmReservation">
            Conferma
          </button>
          <button class="btn btn-secondary" id="cancelReservation">
            Annulla
          </button>
        </div>
      </div>
    </div>

    <!-- ===== SCRIPTS ===== -->
    <script src="/js/home-utente.js"></script>
  </body>
</html>
