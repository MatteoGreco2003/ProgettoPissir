<aside class="sidebar" id="sidebar">
  <nav class="sidebar-nav" id="sidebarNav">
    <!-- I nav-item vengono generati dinamicamente in base al ruolo -->
  </nav>

  <div class="sidebar-footer" id="sidebarFooter">
    <!-- Il pulsante delete profile verrà aggiunto solo se l'utente non è admin -->
  </div>
</aside>

<script>
  // Configurazione navigazione per UTENTE
  const UTENTE_NAV = [
    {
      href: "/home-utente",
      icon: "fas fa-home",
      label: "Homepage",
      dataPage: "homepage",
    },
    {
      href: "/profile",
      icon: "fas fa-user",
      label: "Profilo Utente",
      dataPage: "profile",
    },
    {
      href: "/credit",
      icon: "fas fa-wallet",
      label: "Gestione Credito",
      dataPage: "credit",
    },
    {
      href: "/feedback",
      icon: "fas fa-comment",
      label: "Feedback",
      dataPage: "feedback",
    },
  ];

  // Configurazione navigazione per ADMIN
  const ADMIN_NAV = [
    {
      href: "/home-admin",
      icon: "fas fa-home",
      label: "Dashboard",
      dataPage: "dashboard",
    },
    {
      href: "/profile",
      icon: "fas fa-user",
      label: "Profilo Admin",
      dataPage: "profile",
    },
    {
      href: "/gestione-utenti",
      icon: "fas fa-users",
      label: "Gestione Utenti",
      dataPage: "users",
    },
    {
      href: "/gestione-mezzi",
      icon: "fas fa-bicycle",
      label: "Gestione Mezzi",
      dataPage: "bikes",
    },
    {
      href: "/gestione-parcheggi",
      icon: "fas fa-parking",
      label: "Gestione Parcheggi",
      dataPage: "stations",
    },
    {
      href: "/gestione-corse",
      icon: "fas fa-route",
      label: "Gestione Corse",
      dataPage: "rides",
    },
    {
      href: "/gestione-segnalazioni",
      icon: "fas fa-chart-bar",
      label: "Gestione Report",
      dataPage: "reports",
    },
  ];

  // Genera dinamicamente i nav item in base al ruolo
  function generateNavItems(userRole) {
    const sidebarNav = document.getElementById("sidebarNav");
    if (!sidebarNav) return;

    // Seleziona la configurazione in base al ruolo
    const navConfig = userRole === "admin" ? ADMIN_NAV : UTENTE_NAV;

    sidebarNav.innerHTML = "";

    navConfig.forEach((item) => {
      const navLink = document.createElement("a");
      navLink.href = item.href;
      navLink.className = "nav-item";
      navLink.setAttribute("data-page", item.dataPage);
      navLink.innerHTML = `
        <i class="${item.icon}"></i>
        <span>${item.label}</span>
      `;
      sidebarNav.appendChild(navLink);
    });

    setActiveNavItem();
  }

  // Genera il footer della sidebar in base al ruolo (se l'utente non è admin, mostra il pulsante delete profile)
  function generateSidebarFooter(userRole) {
    const sidebarFooter = document.getElementById("sidebarFooter");
    if (!sidebarFooter) return;

    sidebarFooter.innerHTML = "";

    if (userRole === "admin") {
      sidebarFooter.classList.add("admin");
    } else {
      sidebarFooter.classList.remove("admin");
    }

    // Mostra pulsante delete profile solo se NON è admin
    if (userRole !== "admin") {
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "delete-profile-btn";
      deleteBtn.id = "deleteProfileBtn";
      deleteBtn.innerHTML = `
      <i class="fas fa-trash"></i>
      <span>Elimina Profilo</span>
    `;
      sidebarFooter.appendChild(deleteBtn);

      deleteBtn.addEventListener("click", openDeleteProfileModal);
    }
  }

  // Evidenzia il nav item corrispondente alla pagina corrente
  function setActiveNavItem() {
    const currentPath = window.location.pathname;
    const navItems = document.querySelectorAll(".nav-item");

    navItems.forEach((item) => {
      item.classList.remove("active");
    });

    navItems.forEach((item) => {
      const href = item.getAttribute("href");
      if (
        currentPath === href ||
        (currentPath === "/" && href === "/home-utente")
      ) {
        item.classList.add("active");
      }
    });
  }

  async function loadAndGenerateNavigation() {
    try {
      const response = await fetch("/users/me", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
      });

      if (response.ok) {
        const userData = await response.json();
        generateNavItems(userData.ruolo);
        generateSidebarFooter(userData.ruolo);
      } else {
        console.error("❌ Errore caricamento profilo:", response.status);
      }
    } catch (error) {
      console.error("❌ Errore di connessione:", error);
    }
  }

  function showSnackbar(message, type = "success") {
    const snackbar = document.getElementById("snackbar");
    if (snackbar) {
      snackbar.textContent = message;
      snackbar.className = `snackbar show snackbar--${type}`;
      setTimeout(() => {
        snackbar.classList.remove("show");
      }, 3000);
    }
  }

  function openDeleteProfileModal() {
    const modal = document.getElementById("deleteProfileModal");
    if (modal) {
      modal.classList.remove("hidden");
    }
  }

  function closeDeleteProfileModal() {
    const modal = document.getElementById("deleteProfileModal");
    if (modal) {
      modal.classList.add("hidden");
    }
  }

  async function confirmDeleteProfile() {
    closeDeleteProfileModal();
    showSnackbar("Eliminazione profilo in corso...", "success");

    try {
      const response = await fetch("/users/me", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
      });

      const data = await response.json();

      if (response.ok) {
        showSnackbar("✅ Profilo eliminato con successo", "success");

        setTimeout(() => {
          window.location.href = "/";
        }, 1500);
      } else {
        console.error("❌ Errore eliminazione profilo:", data);
        showSnackbar(data.error || "Errore nell'eliminazione", "error");
      }
    } catch (error) {
      console.error("❌ Errore di connessione:", error);
      showSnackbar("Errore: " + error.message, "error");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadAndGenerateNavigation();

    const sidebarDeleteBtn = document.getElementById("deleteProfileBtn");
    const sidebarCancel = document.getElementById("sidebarModalCancel");
    const sidebarClose = document.getElementById("sidebarModalClose");
    const sidebarConfirm = document.getElementById("sidebarModalConfirm");

    if (sidebarCancel) {
      sidebarCancel.addEventListener("click", closeDeleteProfileModal);
    }

    if (sidebarClose) {
      sidebarClose.addEventListener("click", closeDeleteProfileModal);
    }

    if (sidebarConfirm) {
      sidebarConfirm.addEventListener("click", confirmDeleteProfile);
    }

    const sidebarModal = document.getElementById("deleteProfileModal");
    if (sidebarModal) {
      sidebarModal.addEventListener("click", (e) => {
        if (
          e.target === sidebarModal ||
          e.target.classList.contains("modal-overlay")
        ) {
          closeDeleteProfileModal();
        }
      });
    }
  });
</script>
