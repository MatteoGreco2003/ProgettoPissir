<!-- ============================================================================
     SIDEBAR - COMPONENTE RIUSABILE
     ============================================================================
     Sidebar responsive con navigazione principale e pulsante elimina profilo.
     Incluso script inline per gestione nav attivo e modal eliminazione.
     ========================================================================== -->

<!-- ===== SIDEBAR CONTAINER ===== -->
<aside class="sidebar" id="sidebar">
  <!-- ===== NAVIGAZIONE PRINCIPALE ===== -->
  <nav class="sidebar-nav">
    <!-- Homepage -->
    <a href="/home-utente" class="nav-item active" data-page="homepage">
      <i class="fas fa-home"></i>
      <span>Homepage</span>
    </a>

    <!-- Profilo Utente -->
    <a href="/profile" class="nav-item" data-page="profile">
      <i class="fas fa-user"></i>
      <span>Profilo Utente</span>
    </a>

    <!-- Gestione Credito -->
    <a href="/credit" class="nav-item" data-page="credit">
      <i class="fas fa-wallet"></i>
      <span>Gestione Credito</span>
    </a>

    <!-- Feedback e Valutazioni -->
    <a href="/feedback" class="nav-item" data-page="feedback">
      <i class="fas fa-comment"></i>
      <span>Feedback</span>
    </a>
  </nav>

  <!-- ===== SIDEBAR FOOTER ===== -->
  <div class="sidebar-footer">
    <button class="delete-profile-btn" id="deleteProfileBtn">
      <i class="fas fa-trash"></i>
      <span>Elimina Profilo</span>
    </button>
  </div>
</aside>

<!-- ============================================================================
     SCRIPT INLINE - SIDEBAR LOGIC
     ============================================================================
     Gestisce:
     - Evidenziazione nav item attivo in base al percorso
     - Apertura/chiusura modal eliminazione profilo
     - Eliminazione profilo con API call
     - Gestione click overlay per chiudere modal
     ========================================================================== -->
<script>
  function setActiveNavItem() {
    const currentPath = window.location.pathname;
    const navItems = document.querySelectorAll(".nav-item");

    // Rimuovi classe 'active' da tutti i nav item
    navItems.forEach((item) => {
      item.classList.remove("active");
    });

    // Assegna 'active' al nav item corrispondente al percorso corrente
    if (currentPath === "/home-utente" || currentPath === "/") {
      document.querySelector('[data-page="homepage"]')?.classList.add("active");
    } else if (currentPath === "/profile") {
      document.querySelector('[data-page="profile"]')?.classList.add("active");
    } else if (currentPath === "/credit") {
      document.querySelector('[data-page="credit"]')?.classList.add("active");
    } else if (currentPath === "/feedback") {
      document.querySelector('[data-page="feedback"]')?.classList.add("active");
    }
  }

  /**
   * Mostra snackbar notifica temporanea
   * @param {string} message - Messaggio da mostrare
   * @param {string} type - Tipo: 'success', 'error', 'warning'
   */
  function showSnackbar(message, type = "success") {
    const snackbar = document.getElementById("snackbar");
    if (snackbar) {
      snackbar.textContent = message;
      snackbar.className = `snackbar show snackbar--${type}`;
      setTimeout(() => {
        snackbar.classList.remove("show");
      }, 3000);
    }
  }

  function openDeleteModal() {
    const modal = document.getElementById("deleteProfileModal");
    if (modal) {
      modal.classList.remove("hidden");
    }
  }

  function closeDeleteModal() {
    const modal = document.getElementById("deleteProfileModal");
    if (modal) {
      modal.classList.add("hidden");
    }
  }

  /**
   * Esegue l'eliminazione del profilo via API
   * Mostra snackbar, esegue DELETE /users/me, reindirizza a home
   */
  async function confirmDeleteProfile() {
    closeDeleteModal();
    showSnackbar("Eliminazione profilo in corso...", "success");

    try {
      const response = await fetch("/users/me", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
      });

      const data = await response.json();

      if (response.ok) {
        showSnackbar("✅ Profilo eliminato con successo", "success");

        setTimeout(() => {
          window.location.href = "/";
        }, 1500);
      } else {
        console.error("❌ Errore eliminazione profilo:", data);
        showSnackbar(data.error || "Errore nell'eliminazione", "error");
      }
    } catch (error) {
      console.error("❌ Errore di connessione:", error);
      showSnackbar("Errore: " + error.message, "error");
    }
  }

  // ===== INIT =====
  document.addEventListener("DOMContentLoaded", () => {
    // ===== IMPOSTA NAV ITEM ATTIVO =====
    // Evidenzia il link corrispondente alla pagina corrente
    setActiveNavItem();

    // ===== EVENT LISTENER: Delete Profile Button =====
    const deleteBtn = document.getElementById("deleteProfileBtn");
    if (deleteBtn) {
      deleteBtn.addEventListener("click", openDeleteModal);
    }

    // ===== EVENT LISTENER: Modal Buttons =====
    const modalCancel = document.getElementById("modalCancel");
    const modalClose = document.getElementById("modalClose");
    const modalConfirm = document.getElementById("modalConfirmDelete");

    if (modalCancel) {
      modalCancel.addEventListener("click", closeDeleteModal);
    }

    if (modalClose) {
      modalClose.addEventListener("click", closeDeleteModal);
    }

    if (modalConfirm) {
      modalConfirm.addEventListener("click", confirmDeleteProfile);
    }

    // Chiude modal quando clicchi fuori dal contenuto
    const modal = document.getElementById("deleteProfileModal");
    if (modal) {
      modal.addEventListener("click", (e) => {
        if (
          e.target === modal ||
          e.target.classList.contains("modal-overlay")
        ) {
          closeDeleteModal();
        }
      });
    }
  });
</script>
