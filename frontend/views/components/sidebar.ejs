<!-- ============================================================================
     SIDEBAR - COMPONENTE RIUSABILE
     ============================================================================
     Sidebar responsive con navigazione principale e pulsante elimina profilo.
     Incluso script inline per gestione nav attivo e modal eliminazione.
     ========================================================================== -->

<!-- ===== SIDEBAR CONTAINER ===== -->
<aside class="sidebar" id="sidebar">
  <!-- ===== NAVIGAZIONE PRINCIPALE ===== -->
  <nav class="sidebar-nav" id="sidebarNav">
    <!-- I nav-item generati dinamicamente in base al ruolo -->
  </nav>

  <!-- ===== SIDEBAR FOOTER ===== -->
  <div class="sidebar-footer" id="sidebarFooter">
    <!-- Il pulsante delete profile verrà aggiunto solo se l'utente non è admin -->
  </div>
</aside>

<!-- ============================================================================
     SCRIPT INLINE - SIDEBAR LOGIC
     ============================================================================
     Gestisce:
     - Carica il ruolo utente via API
     - Genera dinamicamente i nav item in base al ruolo
     - Evidenziazione nav item attivo in base al percorso
     - Apertura/chiusura modal eliminazione profilo (solo per utenti non-admin)
     - Eliminazione profilo con API call
     ========================================================================== -->
<script>
  /**
   * Configurazione navigazione per UTENTE
   */
  const UTENTE_NAV = [
    {
      href: "/home-utente",
      icon: "fas fa-home",
      label: "Homepage",
      dataPage: "homepage",
    },
    {
      href: "/profile",
      icon: "fas fa-user",
      label: "Profilo Utente",
      dataPage: "profile",
    },
    {
      href: "/credit",
      icon: "fas fa-wallet",
      label: "Gestione Credito",
      dataPage: "credit",
    },
    {
      href: "/feedback",
      icon: "fas fa-comment",
      label: "Feedback",
      dataPage: "feedback",
    },
  ];

  /**
   * Configurazione navigazione per ADMIN
   */
  const ADMIN_NAV = [
    {
      href: "/home-admin",
      icon: "fas fa-home",
      label: "Dashboard",
      dataPage: "dashboard",
    },
    {
      href: "/profile",
      icon: "fas fa-user",
      label: "Profilo Admin",
      dataPage: "profile",
    },
    {
      href: "/gestione-utenti",
      icon: "fas fa-users",
      label: "Gestione Utenti",
      dataPage: "users",
    },
    {
      href: "/gestione-mezzi",
      icon: "fas fa-bicycle",
      label: "Gestione Mezzi",
      dataPage: "bikes",
    },
    {
      href: "/gestione-parcheggi",
      icon: "fas fa-parking",
      label: "Gestione Parcheggi",
      dataPage: "stations",
    },
    {
      href: "/gestione-corse",
      icon: "fas fa-route",
      label: "Gestione Corse",
      dataPage: "rides",
    },
    {
      href: "/gestione-segnalazioni",
      icon: "fas fa-chart-bar",
      label: "Gestione Report",
      dataPage: "reports",
    },
  ];

  /**
   * Genera dinamicamente i nav item in base al ruolo
   * @param {string} userRole - Ruolo dell'utente ('utente' o 'admin')
   */
  function generateNavItems(userRole) {
    const sidebarNav = document.getElementById("sidebarNav");
    if (!sidebarNav) return;

    // Seleziona la configurazione in base al ruolo
    const navConfig = userRole === "admin" ? ADMIN_NAV : UTENTE_NAV;

    // Pulisci nav precedente
    sidebarNav.innerHTML = "";

    // Crea e inserisci i nav item
    navConfig.forEach((item) => {
      const navLink = document.createElement("a");
      navLink.href = item.href;
      navLink.className = "nav-item";
      navLink.setAttribute("data-page", item.dataPage);
      navLink.innerHTML = `
        <i class="${item.icon}"></i>
        <span>${item.label}</span>
      `;
      sidebarNav.appendChild(navLink);
    });

    // Dopo la generazione, evidenzia il link attivo
    setActiveNavItem();
  }

  /**
   * Genera il footer della sidebar in base al ruolo
   * Se l'utente non è admin, mostra il pulsante delete profile
   * @param {string} userRole - Ruolo dell'utente ('utente' o 'admin')
   */
  function generateSidebarFooter(userRole) {
    const sidebarFooter = document.getElementById("sidebarFooter");
    if (!sidebarFooter) return;

    // Pulisci footer precedente
    sidebarFooter.innerHTML = "";

    // Se è admin, aggiungi la classe 'admin' al footer per nascondere il border
    if (userRole === "admin") {
      sidebarFooter.classList.add("admin");
    } else {
      sidebarFooter.classList.remove("admin");
    }

    // Mostra pulsante delete profile solo se NON è admin
    if (userRole !== "admin") {
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "delete-profile-btn";
      deleteBtn.id = "deleteProfileBtn";
      deleteBtn.innerHTML = `
      <i class="fas fa-trash"></i>
      <span>Elimina Profilo</span>
    `;
      sidebarFooter.appendChild(deleteBtn);

      // Aggiungi event listener al pulsante
      deleteBtn.addEventListener("click", openDeleteProfileModal);
    }
  }

  /**
   * Evidenzia il nav item corrispondente alla pagina corrente
   */
  function setActiveNavItem() {
    const currentPath = window.location.pathname;
    const navItems = document.querySelectorAll(".nav-item");

    navItems.forEach((item) => {
      item.classList.remove("active");
    });

    // Cerca il nav item che corrisponde al percorso
    navItems.forEach((item) => {
      const href = item.getAttribute("href");
      if (
        currentPath === href ||
        (currentPath === "/" && href === "/home-utente")
      ) {
        item.classList.add("active");
      }
    });
  }

  /**
   * Carica il ruolo utente e genera la navigazione
   */
  async function loadAndGenerateNavigation() {
    try {
      const response = await fetch("/users/me", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
      });

      if (response.ok) {
        const userData = await response.json();
        // Genera nav in base al ruolo
        generateNavItems(userData.ruolo);
        // Genera footer (con pulsante delete solo se NON admin)
        generateSidebarFooter(userData.ruolo);
      } else {
        console.error("❌ Errore caricamento profilo:", response.status);
      }
    } catch (error) {
      console.error("❌ Errore di connessione:", error);
    }
  }

  /**
   * Mostra snackbar notifica temporanea
   * @param {string} message - Messaggio da mostrare
   * @param {string} type - Tipo: 'success', 'error', 'warning'
   */
  function showSnackbar(message, type = "success") {
    const snackbar = document.getElementById("snackbar");
    if (snackbar) {
      snackbar.textContent = message;
      snackbar.className = `snackbar show snackbar--${type}`;
      setTimeout(() => {
        snackbar.classList.remove("show");
      }, 3000);
    }
  }

  // ✅ SIDEBAR PROFILE MODAL FUNCTIONS (DIVERSI DA REPORTS)
  function openDeleteProfileModal() {
    const modal = document.getElementById("deleteProfileModal");
    if (modal) {
      modal.classList.remove("hidden");
    }
  }

  function closeDeleteProfileModal() {
    const modal = document.getElementById("deleteProfileModal");
    if (modal) {
      modal.classList.add("hidden");
    }
  }

  /**
   * Esegue l'eliminazione del profilo via API
   * Mostra snackbar, esegue DELETE /users/me, reindirizza a home
   */
  async function confirmDeleteProfile() {
    closeDeleteProfileModal();
    showSnackbar("Eliminazione profilo in corso...", "success");

    try {
      const response = await fetch("/users/me", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
      });

      const data = await response.json();

      if (response.ok) {
        showSnackbar("✅ Profilo eliminato con successo", "success");

        setTimeout(() => {
          window.location.href = "/";
        }, 1500);
      } else {
        console.error("❌ Errore eliminazione profilo:", data);
        showSnackbar(data.error || "Errore nell'eliminazione", "error");
      }
    } catch (error) {
      console.error("❌ Errore di connessione:", error);
      showSnackbar("Errore: " + error.message, "error");
    }
  }

  // ===== INIT =====
  document.addEventListener("DOMContentLoaded", () => {
    // ===== CARICA NAV IN BASE AL RUOLO =====
    loadAndGenerateNavigation();

    // ===== EVENT LISTENER: Sidebar Modal Buttons (DIVERSI) =====
    const sidebarDeleteBtn = document.getElementById("deleteProfileBtn");
    const sidebarCancel = document.getElementById("sidebarModalCancel");
    const sidebarClose = document.getElementById("sidebarModalClose");
    const sidebarConfirm = document.getElementById("sidebarModalConfirm");

    if (sidebarCancel) {
      sidebarCancel.addEventListener("click", closeDeleteProfileModal);
    }

    if (sidebarClose) {
      sidebarClose.addEventListener("click", closeDeleteProfileModal);
    }

    if (sidebarConfirm) {
      sidebarConfirm.addEventListener("click", confirmDeleteProfile);
    }

    // Chiude modal quando clicchi fuori dal contenuto (SOLO PER SIDEBAR)
    const sidebarModal = document.getElementById("deleteProfileModal");
    if (sidebarModal) {
      sidebarModal.addEventListener("click", (e) => {
        if (
          e.target === sidebarModal ||
          e.target.classList.contains("modal-overlay")
        ) {
          closeDeleteProfileModal();
        }
      });
    }
  });
</script>
